---
title: "Chapter 6 - Data Visualization"
author: "Nicolas Restrepo"
output: 
  html_document: 
    toc: true
    theme: united
    keep_md: true
---




In this homework, we will review some of the ideas and tools that Healy presents in chapter 6 of Data Visualization. This is a chapter packed full of information. Some of the techniques - like marginal plots - might have flown over your head. And that's fine because we haven't reviewed logistic regression. But I will ask you to trust that these tools are useful to have at least in the back of your head, and that - as your data analysis journey continues - you will come back to this chapter recurrently. Here, we will focus on some of the key skills that resonate with the content we have reviewed so far. 

For this homework, we are you to be using player data from the 2019 NBA season. I was able to download and curate this data using [David Schoch's code](https://www.r-bloggers.com/2018/03/analyzing-nba-player-data-i-getting-data/). You should really check out his blog. 

As always, we will begin by reading in the data and looking at its structure. 


```r
library(tidyverse)
nba_data <- read_csv("../Data/nba_player_data.csv")
glimpse(nba_data)
```

```
## Rows: 530
## Columns: 70
## $ player         <chr> "Aaron Gordon", "Aaron Holiday", "Abdel Nader", "Al Hor…
## $ pos            <chr> "PF", "PG", "SF", "C", "PF", "PF", "SG", "SG", "PG", "C…
## $ age            <dbl> 23, 22, 25, 32, 28, 26, 27, 25, 24, 25, 25, 26, 22, 26,…
## $ tm             <chr> "ORL", "IND", "OKC", "BOS", "POR", "BRK", "TOT", "OKC",…
## $ g              <dbl> 78, 50, 61, 68, 81, 5, 64, 31, 25, 77, 21, 72, 14, 43, …
## $ gs             <dbl> 78, 0, 1, 68, 81, 0, 24, 2, 4, 31, 1, 5, 0, 20, 3, 0, 6…
## $ mp             <dbl> 2633, 646, 694, 1973, 2292, 26, 1375, 588, 531, 1544, 3…
## $ fg             <dbl> 470, 105, 91, 387, 257, 8, 192, 56, 77, 320, 40, 134, 4…
## $ fga            <dbl> 1046, 262, 215, 723, 593, 13, 474, 157, 173, 648, 81, 2…
## $ fg_percent     <dbl> 0.449, 0.401, 0.423, 0.535, 0.433, 0.615, 0.405, 0.357,…
## $ x3p            <dbl> 121, 43, 32, 73, 96, 0, 61, 41, 24, 74, 9, 42, 1, 98, 5…
## $ x3pa           <dbl> 347, 127, 100, 203, 280, 1, 168, 127, 50, 204, 23, 118,…
## $ x3p_percent    <dbl> 0.349, 0.339, 0.320, 0.360, 0.343, 0.000, 0.363, 0.323,…
## $ x2p            <dbl> 349, 62, 59, 314, 161, 8, 131, 15, 53, 246, 31, 92, 3, …
## $ x2pa           <dbl> 699, 135, 115, 520, 313, 12, 306, 30, 123, 444, 58, 157…
## $ x2p_percent    <dbl> 0.499, 0.459, 0.513, 0.604, 0.514, 0.667, 0.428, 0.500,…
## $ e_fg_percent   <dbl> 0.507, 0.483, 0.498, 0.586, 0.514, 0.615, 0.469, 0.487,…
## $ ft             <dbl> 185, 41, 27, 78, 150, 2, 116, 12, 51, 140, 18, 27, 4, 4…
## $ fta            <dbl> 253, 50, 36, 95, 173, 4, 141, 13, 64, 216, 29, 48, 8, 5…
## $ ft_percent     <dbl> 0.731, 0.820, 0.750, 0.821, 0.867, 0.500, 0.823, 0.923,…
## $ orb            <dbl> 129, 5, 14, 120, 112, 4, 30, 5, 20, 158, 29, 81, 4, 16,…
## $ drb            <dbl> 445, 62, 102, 338, 498, 15, 205, 43, 47, 266, 47, 166, …
## $ trb            <dbl> 574, 67, 116, 458, 610, 19, 235, 48, 67, 424, 76, 247, …
## $ ast            <dbl> 289, 87, 20, 283, 104, 3, 128, 20, 77, 86, 17, 31, 1, 4…
## $ stl            <dbl> 57, 21, 20, 59, 68, 1, 39, 17, 24, 27, 4, 18, 1, 23, 28…
## $ blk            <dbl> 56, 13, 12, 86, 33, 0, 21, 6, 9, 69, 10, 15, 3, 13, 14,…
## $ tov            <dbl> 162, 40, 26, 102, 72, 1, 65, 14, 42, 97, 13, 30, 0, 46,…
## $ pf             <dbl> 172, 71, 68, 126, 143, 2, 91, 53, 54, 200, 47, 134, 7, …
## $ pts            <dbl> 1246, 294, 241, 925, 760, 18, 561, 165, 229, 854, 107, …
## $ fg_pm          <dbl> 6.4, 5.9, 4.7, 7.1, 4.0, 11.1, 5.0, 3.4, 5.2, 7.5, 4.7,…
## $ fga_pm         <dbl> 14.3, 14.6, 11.2, 13.2, 9.3, 18.0, 12.4, 9.6, 11.7, 15.…
## $ fg_percent_pm  <dbl> 0.449, 0.401, 0.423, 0.535, 0.433, 0.615, 0.405, 0.357,…
## $ x3p_pm         <dbl> 1.7, 2.4, 1.7, 1.3, 1.5, 0.0, 1.6, 2.5, 1.6, 1.7, 1.1, …
## $ x3pa_pm        <dbl> 4.7, 7.1, 5.2, 3.7, 4.4, 1.4, 4.4, 7.8, 3.4, 4.8, 2.7, …
## $ x3p_percent_pm <dbl> 0.349, 0.339, 0.320, 0.360, 0.343, 0.000, 0.363, 0.323,…
## $ x2p_pm         <dbl> 4.8, 3.5, 3.1, 5.7, 2.5, 11.1, 3.4, 0.9, 3.6, 5.7, 3.7,…
## $ x2pa_pm        <dbl> 9.6, 7.5, 6.0, 9.5, 4.9, 16.6, 8.0, 1.8, 8.3, 10.4, 6.8…
## $ x2p_percent_pm <dbl> 0.499, 0.459, 0.513, 0.604, 0.514, 0.667, 0.428, 0.500,…
## $ ft_pm          <dbl> 2.5, 2.3, 1.4, 1.4, 2.4, 2.8, 3.0, 0.7, 3.5, 3.3, 2.1, …
## $ fta_pm         <dbl> 3.5, 2.8, 1.9, 1.7, 2.7, 5.5, 3.7, 0.8, 4.3, 5.0, 3.4, …
## $ ft_percent_pm  <dbl> 0.731, 0.820, 0.750, 0.821, 0.867, 0.500, 0.823, 0.923,…
## $ orb_pm         <dbl> 1.8, 0.3, 0.7, 2.2, 1.8, 5.5, 0.8, 0.3, 1.4, 3.7, 3.4, …
## $ drb_pm         <dbl> 6.1, 3.5, 5.3, 6.2, 7.8, 20.8, 5.4, 2.6, 3.2, 6.2, 5.5,…
## $ trb_pm         <dbl> 7.8, 3.7, 6.0, 8.4, 9.6, 26.3, 6.2, 2.9, 4.5, 9.9, 9.0,…
## $ ast_pm         <dbl> 4.0, 4.8, 1.0, 5.2, 1.6, 4.2, 3.4, 1.2, 5.2, 2.0, 2.0, …
## $ stl_pm         <dbl> 0.8, 1.2, 1.0, 1.1, 1.1, 1.4, 1.0, 1.0, 1.6, 0.6, 0.5, …
## $ blk_pm         <dbl> 0.8, 0.7, 0.6, 1.6, 0.5, 0.0, 0.5, 0.4, 0.6, 1.6, 1.2, …
## $ tov_pm         <dbl> 2.2, 2.2, 1.3, 1.9, 1.1, 1.4, 1.7, 0.9, 2.8, 2.3, 1.5, …
## $ pf_pm          <dbl> 2.4, 4.0, 3.5, 2.3, 2.2, 2.8, 2.4, 3.2, 3.7, 4.7, 5.5, …
## $ pts_pm         <dbl> 17.0, 16.4, 12.5, 16.9, 11.9, 24.9, 14.7, 10.1, 15.5, 1…
## $ per            <dbl> 15.1, 11.9, 8.8, 20.2, 13.2, 32.9, 12.7, 6.3, 13.9, 17.…
## $ ts_percent     <dbl> 0.538, 0.518, 0.522, 0.605, 0.568, 0.610, 0.523, 0.507,…
## $ x3p_ar         <dbl> 0.332, 0.485, 0.465, 0.281, 0.472, 0.077, 0.354, 0.809,…
## $ f_tr           <dbl> 0.242, 0.191, 0.167, 0.131, 0.292, 0.308, 0.297, 0.083,…
## $ orb_percent    <dbl> 5.2, 0.9, 2.0, 6.5, 5.3, 16.2, 2.3, 0.9, 4.0, 10.5, 9.8…
## $ drb_percent    <dbl> 18.4, 10.4, 15.7, 18.3, 22.6, 60.3, 17.0, 7.8, 9.0, 18.…
## $ trb_percent    <dbl> 11.7, 5.8, 8.6, 12.4, 14.2, 38.4, 9.4, 4.2, 6.5, 14.4, …
## $ ast_percent    <dbl> 16.6, 19.3, 3.8, 21.2, 6.0, 22.3, 13.7, 4.3, 19.7, 8.6,…
## $ stl_percent    <dbl> 1.1, 1.6, 1.3, 1.4, 1.4, 1.8, 1.4, 1.3, 2.1, 0.8, 0.6, …
## $ blk_percent    <dbl> 1.8, 1.8, 1.5, 3.9, 1.2, 0.0, 1.3, 0.9, 1.4, 3.9, 2.8, …
## $ tov_percent    <dbl> 12.3, 12.3, 10.1, 11.8, 9.7, 6.3, 10.8, 7.9, 17.3, 11.5…
## $ usg_percent    <dbl> 21.8, 21.9, 15.1, 18.9, 13.7, 25.5, 19.0, 12.2, 19.0, 2…
## $ ows            <dbl> 1.8, 0.1, 0.0, 4.5, 3.0, 0.1, 0.7, 0.1, 0.5, 2.2, 0.4, …
## $ dws            <dbl> 3.3, 0.8, 0.9, 2.9, 2.8, 0.1, 0.8, 0.6, 0.6, 1.0, 0.2, …
## $ ws             <dbl> 5.1, 0.9, 0.9, 7.5, 5.8, 0.2, 1.5, 0.6, 1.0, 3.2, 0.5, …
## $ ws_48          <dbl> 0.093, 0.065, 0.062, 0.181, 0.121, 0.312, 0.052, 0.053,…
## $ obpm           <dbl> 0.3, -1.7, -3.6, 3.3, 0.1, 7.6, -0.6, -3.7, -1.0, 0.0, …
## $ dbpm           <dbl> 0.3, 0.1, 0.3, 1.9, 0.6, 4.2, -0.7, 0.4, 0.7, -1.3, -1.…
## $ bpm            <dbl> 0.6, -1.6, -3.2, 5.1, 0.7, 11.8, -1.2, -3.3, -0.2, -1.2…
## $ vorp           <dbl> 1.7, 0.1, -0.2, 3.6, 1.5, 0.1, 0.3, -0.2, 0.2, 0.3, -0.…
```

We have a ton of information. Each row represents a player and we have detailed statistics of their performance across the season. I will come clean and admit that I know very little about Basketball analytics. If you are an expert then the exercises might seem rather silly. If so, I'm looking to hear what you can do with this wealth of data. Given my inexperience, I will focus only on a few variables. The main variable I am interested in is `per`: player efficiency rating. This is basically a measure of how much a player contributes in proportion to the time it spends on the court. What I am interested in is what aspects of the game - like 2 pointers or 3 pointers - lead to higher efficiency ratings. One can think that a player who is better at 2 pointers might contribute more, given that these shots are more common. However, 3 pointers are, well, worth more. We will examine this. 

## Question 1 

First, a review question: in the chapter Healy outlines three pieces of advice for presenting statistical results visually. Summarize them in your own words. 

## Question 2 

Now, let's begin by looking at the data. Make a plot with `x2p_percent_pm` in the x-axis and `per` in the y-axis. The first variable captures the percentage of 2-pointers players scored in relation to how many they tried. The `pm` suffix reflects that this data takes into account per-minute data: it counts the 2-pointer percentage for intervals of 36 minutes. Okay, make the plot. 

What patterns do you see? 

There are really extreme outliers. Especially, there are two weird players: one whose efficiency rating is ridiculously high and another who made all of their 2-pointers. Can you figure out who they are and why their stats are weird? 

> Hint: look at the `mp` column which represents the minutes played. 

## Question 3 

Following the book, show several fits at once. Just like in the chapter, show a Cubic Spline, a LOESS curve, and an OLS line alongside the data. Do you notice any differences? What happens when you `filter()` the data so that you only consider players who have played more than 300 minutes (roughly the 25th quantile of the data)?

## Question 4

Now, make the same graph but with `x3p_percent_pm` in the x-axis. This is essentially the same metric as above but for 3-pointers. Tell me what you notice? Any similar outliers as above? 

By now, you should realize that `mp` plays a big role. If you have played little, weird stuff happens. The longer you play, the more your stats regress to the mean. That's a valuable lesson in statistics. 

## Question 5

Let's do the three fitted lines with these data now, just like you did in question 3. What do you notice here? 
## Question 6

Okay, let's build a model and practice how to plot predicted values from that model. Here, I am interested in a model that predicts a player's efficiency rating - `per` - using the percentage of 2-pointers (`x2p_percent_pm`) and accounting for position (`pos`) and minutes played (`mp`). Fit that model and call it `mod1`.  

Now we are interested in recreating in figure 6.4 from the book, but using our new model instead. The x-axis then should contain the range of `x2p_percent_pm`. The y-axis should include our original data of players' efficiency ratings as well as lines that denote our inferences and uncertainty. The lines should be grouped by position. We will hold the minutes played to the league median. I will give you the dataframe that you can use to predict new data. After that you are on your own. 


```r
pred_df <- expand.grid(pos = unique(nba_data$pos),
                       mp = median(nba_data$mp),
                       x2p_percent_pm = (seq(from = min(nba_data$x2p_percent_pm),
                                        to = max(nba_data$x2p_percent_pm),
                                        length.out = 100)))
```

Briefly describes what your plotted estimates show. 

## Question 7

This next exercise is going to be mostly on you. I am going to provide little guidance, but all the code you need is on the chapter. 

I want to understand what aspects of the game contribute more to the efficiency rating. Build a model where efficiency rating is the outcome variable and where you include the following explanatory variables:

1) `mp` - minutes played
2) `x2p_percent_pm` - percentage of 2-pointers
3) `x3p_percent_pm` - percentage of 3-pointers
4)  `blk_pm` - blocks per minute
5)  `orb_pm` - offensive rebounds per minute
6) `drb_pm` - defensive rebounds per minute
7) `ast_pm` - assists per minute
8) `stl_pm` - steals per minute 

After you have fitted the models make a coefficient plot similar to the one on Figure 6.6. The errorbars should represent 2 standard errors. 

Describe your results in your own words. 

One of the criticisms of the player efficiency metric is that it weights more heavily offensive skills. Do your results support this criticism? 
